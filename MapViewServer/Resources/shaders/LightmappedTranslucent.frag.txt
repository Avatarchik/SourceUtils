precision mediump float;

varying vec2 vTextureCoord;
varying vec2 vLightmapCoord;
varying float vDepth;

uniform sampler2D uBaseTexture;
uniform sampler2D uLightmap;

// x: near fog density, y: far plane fog density
uniform vec2 uFogParams;
uniform vec3 uFogColor;

uniform float uAlpha;

void main()
{
    vec4 texSample = texture2D(uBaseTexture, vTextureCoord);

    float depth = ((2.0 * gl_FragCoord.z - gl_DepthRange.near - gl_DepthRange.far) / (gl_DepthRange.far - gl_DepthRange.near)) / gl_FragCoord.w;
    float fogDensity = uFogParams.x + uFogParams.y * depth;

    fogDensity = min(max(fogDensity, 0.0), 1.0);

    vec3 lightmap = texture2D(uLightmap, vLightmapCoord).rgb;
    vec3 color = texSample.rgb * lightmap * (1.0 - fogDensity) + uFogColor * fogDensity;

    gl_FragColor = vec4(color, texSample.a * uAlpha);
}
